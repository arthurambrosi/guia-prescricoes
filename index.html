<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guia de Prescrições</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Literata:wght@400;600;700&family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      color-scheme: light;
      --ink: #102A3A;
      --muted: #5C6F7A;
      --accent: #0C6A7A;
      --accent-strong: #0B3A53;
      --warm: #F4C06A;
      --surface: #F5F1E8;
      --panel: #FFFFFF;
      --border: rgba(16, 42, 58, 0.12);
      --shadow: 0 22px 60px -40px rgba(16, 42, 58, 0.6);
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Source Sans 3", sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at top left, #F8EBD4 0%, #F5F1E8 38%, #E6F2F5 100%);
      min-height: 100vh;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .page {
      max-width: 1140px;
      margin: 0 auto;
      padding: 32px 24px 80px;
    }

    .hero {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.8fr);
      gap: 24px;
      align-items: stretch;
      margin-top: 12px;
    }

    .hero__content {
      padding: 28px;
      border-radius: var(--radius);
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
    }

    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.2em;
      font-size: 0.72rem;
      font-weight: 700;
      color: var(--accent);
      margin: 0 0 12px;
    }

    h1 {
      font-family: "Literata", serif;
      font-size: clamp(2.2rem, 3vw, 3.1rem);
      margin: 0 0 12px;
    }

    .lead {
      font-size: 1.05rem;
      color: var(--muted);
      margin: 0 0 20px;
    }

    .hero__actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 18px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-weight: 600;
      background: var(--accent);
      color: white;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 12px 25px -18px rgba(12, 106, 122, 0.8);
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .btn--ghost {
      background: transparent;
      border-color: var(--border);
      color: var(--accent-strong);
      box-shadow: none;
    }

    .hero__panel {
      display: grid;
      gap: 16px;
    }

    .stat {
      background: white;
      border-radius: var(--radius);
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .stat__value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-strong);
    }

    .stat__label {
      color: var(--muted);
      margin-top: 4px;
    }

    .filters {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 0.7fr) auto;
      gap: 12px;
      margin: 32px 0 20px;
    }

    input[type="search"],
    select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 0.98rem;
      background: white;
    }

    .clear-btn {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: transparent;
      font-weight: 600;
      color: var(--accent-strong);
      cursor: pointer;
    }

    .cards {
      display: grid;
      gap: 16px;
    }

    .card {
      background: white;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 18px 20px;
      box-shadow: var(--shadow);
    }

    .card__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .card__title {
      margin: 6px 0 0;
      font-family: "Literata", serif;
      font-size: 1.3rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(12, 106, 122, 0.12);
      color: var(--accent-strong);
      font-weight: 600;
      font-size: 0.78rem;
    }

    .toggle {
      border: 1px solid var(--border);
      background: transparent;
      border-radius: 999px;
      padding: 8px 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .card__content {
      margin-top: 16px;
      display: none;
    }

    .card--open .card__content {
      display: block;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tab {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      background: #F8FAFB;
      font-weight: 600;
      cursor: pointer;
      color: var(--muted);
    }

    .tab--active {
      background: var(--accent);
      color: white;
      border-color: transparent;
    }

    .tab-panel {
      display: none;
      border-radius: 14px;
      padding: 12px 14px;
      background: #F8FAFB;
      border: 1px solid var(--border);
    }

    .tab-panel--active {
      display: block;
    }

    .tab-panel h1,
    .tab-panel h2,
    .tab-panel h3 {
      font-family: "Literata", serif;
      margin-top: 0;
    }

    .muted {
      color: var(--muted);
    }

    .empty-state {
      text-align: center;
      color: var(--muted);
      padding: 24px;
      border: 1px dashed var(--border);
      border-radius: var(--radius);
    }

    .footer {
      margin-top: 48px;
      color: var(--muted);
      font-size: 0.9rem;
      text-align: center;
    }

    @media (max-width: 900px) {
      .hero {
        grid-template-columns: 1fr;
      }

      .filters {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="hero">
      <div class="hero__content">
        <p class="eyebrow">Uso Jaleco</p>
        <h1>Guia de Prescrições</h1>
        <p class="lead">Organize protocolos, critérios e prescrições em um só lugar. Edite pelo painel administrativo e o site atualiza automaticamente.</p>
        <div class="hero__actions">
          <a class="btn" href="/admin/">Adicionar ou editar</a>
          <a class="btn btn--ghost" href="#guia">Ver guias</a>
        </div>
      </div>
      <div class="hero__panel">
        <div class="stat">
          <div class="stat__value" id="totalCount">0</div>
          <div class="stat__label">Prescrições cadastradas</div>
        </div>
        <div class="stat">
          <div class="stat__value" id="lastUpdate">-</div>
          <div class="stat__label">Última atualização</div>
        </div>
      </div>
    </header>

    <main id="guia">
      <section class="filters">
        <input type="search" id="search" placeholder="Buscar por assunto ou palavra-chave" />
        <select id="areaFilter">
          <option value="">Todas as áreas</option>
        </select>
        <button class="clear-btn" id="clear">Limpar filtros</button>
      </section>

      <section class="cards" id="list"></section>
      <div class="footer">Dica: para criar divisórias no editor, use três traços `---` em uma linha.</div>
    </main>
  </div>

  <template id="cardTemplate">
    <article class="card">
      <div class="card__header">
        <div>
          <span class="pill"></span>
          <h2 class="card__title"></h2>
        </div>
        <button class="toggle" type="button">Abrir</button>
      </div>
      <div class="card__content">
        <div class="tabs">
          <button class="tab" type="button" data-tab="criterios">Critérios</button>
          <button class="tab" type="button" data-tab="dicas">Dicas</button>
          <button class="tab" type="button" data-tab="exames">Exames complementares</button>
          <button class="tab" type="button" data-tab="prescricao">Prescrição</button>
        </div>
        <div class="tab-panel" data-panel="criterios"></div>
        <div class="tab-panel" data-panel="dicas"></div>
        <div class="tab-panel" data-panel="exames"></div>
        <div class="tab-panel" data-panel="prescricao"></div>
      </div>
    </article>
  </template>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const listEl = document.getElementById('list')
    const areaFilter = document.getElementById('areaFilter')
    const searchInput = document.getElementById('search')
    const clearBtn = document.getElementById('clear')
    const totalCountEl = document.getElementById('totalCount')
    const lastUpdateEl = document.getElementById('lastUpdate')
    const template = document.getElementById('cardTemplate')

    const state = {
      data: []
    }

    function normalize(value) {
      if (!value) {
        return ''
      }
      return value
        .toString()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
    }

    function formatDate(value) {
      if (!value) {
        return '-'
      }
      const date = new Date(value)
      if (Number.isNaN(date.getTime())) {
        return value
      }
      return date.toLocaleDateString('pt-BR')
    }

    function markdown(value) {
      if (!value) {
        return '<p class="muted">Sem conteúdo.</p>'
      }
      return marked.parse(value)
    }

    function activateTab(card, tabName) {
      const tabs = card.querySelectorAll('.tab')
      const panels = card.querySelectorAll('.tab-panel')
      tabs.forEach((btn) => {
        const isActive = btn.dataset.tab === tabName
        btn.classList.toggle('tab--active', isActive)
      })
      panels.forEach((panel) => {
        const isActive = panel.dataset.panel === tabName
        panel.classList.toggle('tab-panel--active', isActive)
      })
    }

    function buildCard(item) {
      const node = template.content.cloneNode(true)
      const card = node.querySelector('.card')
      const pill = node.querySelector('.pill')
      const title = node.querySelector('.card__title')
      const toggle = node.querySelector('.toggle')
      const panels = node.querySelectorAll('.tab-panel')
      const tabs = node.querySelectorAll('.tab')

      pill.textContent = item.area || 'Sem área'
      title.textContent = item.assunto || 'Sem assunto'

      panels.forEach((panel) => {
        if (panel.dataset.panel === 'criterios') {
          panel.innerHTML = markdown(item.criterios)
        }
        if (panel.dataset.panel === 'dicas') {
          panel.innerHTML = markdown(item.dicas)
        }
        if (panel.dataset.panel === 'exames') {
          panel.innerHTML = markdown(item.exames)
        }
        if (panel.dataset.panel === 'prescricao') {
          panel.innerHTML = markdown(item.prescricao)
        }
      })

      tabs.forEach((tab) => {
        tab.addEventListener('click', () => activateTab(card, tab.dataset.tab))
      })

      toggle.addEventListener('click', () => {
        const isOpen = card.classList.toggle('card--open')
        toggle.textContent = isOpen ? 'Fechar' : 'Abrir'
        if (isOpen) {
          activateTab(card, 'criterios')
        }
      })

      return node
    }

    function updateStats(items) {
      totalCountEl.textContent = items.length
      let latest = null
      items.forEach((item) => {
        if (!item.atualizado_em) {
          return
        }
        const date = new Date(item.atualizado_em)
        if (Number.isNaN(date.getTime())) {
          return
        }
        if (!latest || date > latest) {
          latest = date
        }
      })
      lastUpdateEl.textContent = latest ? formatDate(latest.toISOString()) : '-'
    }

    function renderList(items) {
      listEl.innerHTML = ''
      if (!items.length) {
        const empty = document.createElement('div')
        empty.className = 'empty-state'
        empty.textContent = 'Nenhuma prescrição encontrada. Use o botão “Adicionar ou editar”.'
        listEl.appendChild(empty)
        updateStats(items)
        return
      }
      items.forEach((item) => {
        listEl.appendChild(buildCard(item))
      })
      updateStats(items)
    }

    function filterAndRender() {
      const term = normalize(searchInput.value.trim())
      const area = areaFilter.value.trim()
      const results = []

      state.data.forEach((item) => {
        const combined = [
          item.assunto,
          item.area,
          item.criterios,
          item.dicas,
          item.exames,
          item.prescricao
        ].join(' ')
        const normalized = normalize(combined)

        let matchesTerm = true
        if (term !== '') {
          matchesTerm = normalized.includes(term)
        }

        let matchesArea = true
        if (area !== '') {
          matchesArea = item.area === area
        }

        if (matchesTerm) {
          if (matchesArea) {
            results.push(item)
          }
        }
      })

      renderList(results)
    }

    function populateAreas(items) {
      const areas = []
      items.forEach((item) => {
        if (item.area && !areas.includes(item.area)) {
          areas.push(item.area)
        }
      })
      areas.sort()
      areas.forEach((area) => {
        const option = document.createElement('option')
        option.value = area
        option.textContent = area
        areaFilter.appendChild(option)
      })
    }

    async function loadData() {
      try {
        const response = await fetch('./data/prescricoes.json', { cache: 'no-store' })
        if (!response.ok) {
          throw new Error('Falha ao carregar dados')
        }
        const payload = await response.json()
        state.data = payload.prescricoes || []
        populateAreas(state.data)
        renderList(state.data)
      } catch (error) {
        listEl.innerHTML = ''
        const empty = document.createElement('div')
        empty.className = 'empty-state'
        empty.textContent = 'Não foi possível carregar o arquivo de prescrições. Verifique o data/prescricoes.json.'
        listEl.appendChild(empty)
      }
    }

    searchInput.addEventListener('input', filterAndRender)
    areaFilter.addEventListener('change', filterAndRender)
    clearBtn.addEventListener('click', () => {
      searchInput.value = ''
      areaFilter.value = ''
      renderList(state.data)
    })

    loadData()
  </script>
</body>
</html>
